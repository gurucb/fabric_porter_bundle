### Using Porter with Fabric mixin

This bundle provides example of how to use Fabric Mixin with Porter. Using this bundle Fabric Workspace and items (artifacts) in worspace can be created.

## Pre-requisites
In order to create fabric resources, you will first need to create below.
1. Create Fabric Capacity on Azure  https://learn.microsoft.com/en-us/fabric/admin/capacity-settings?tabs=fabric-capacity#get-to-the-capacity-settings
2. Generate Authz token
https://developer.fabric.inc/v2/api-reference/offers-v1/login-api/generate-authorization-token-for-local-user
3. Save the token generated from step 2 and set environmental variables

``` bash
export Microsoft_Fabric_Token=<"token from step 2">
```

``` bash
export Microsoft_StatusDBConnectionString="value" 
```

Microsoft_StatusDBConnectionString is yet to be implemented.

Fabric Mixin uses credentials for OBO tokens and connection strings. These credentials refer to environmental variables that were set in previous step.
``` yaml
credentials:
  - name: Microsoft_Fabric_Token
    env: Microsoft_Fabric_Token
    applyTo: 
      - install
  - name: Microsoft_StatusDBConnectionString
    env: Microsoft_StatusDBConnectionString
    applyTo:
      - install 
```

Additionally parameters are used to capture and change values dynamically at runtime. 

``` yaml
parameters: 
   - name: subscriptionId
    type: string
    default: "default_subscription"
    isRequired: false
  - name: resourceGroup
    default: "default_resourcegroup"
    type: string
    isRequired: false
  - name: location
    default: "default_location"
    type: string
    isRequired: false
  - name: workspaceDisplayName
    type: string
    isRequired: true
  - name: workspaceDescription
    type: string
    default: "United Fabric Workspace"
    isRequired: false
  - name: capacityId
    type: string
    isRequired: true
  - name: correlationId
    type: string
    isRequired: true
  - name: itemDisplayName
    type: string
    isRequired: true
  - name: itemDescription
    type: string
    default: "United Fabric Item"
    isRequired: false
  - name: itemType
    type: string
    isRequired: true
  - name: workspaceId ## Only if Item is passed in Porter YAML.
    type: string
    default: ""
    isRequired: false
```
Finally porter.yaml refers to fabric mixin and install action with arguments, flags and outputs.
``` yaml
mixins:
  - fabric
install:
  - fabric:
      description: "Creating Workspace"
      group: core.workspace
      operation: CreateWorkspace
      flags:
        displayName: ${ bundle.parameters.workspaceDisplayName }
        type: "Workspace"
        Token: ${ bundle.credentials.Microsoft_Fabric_Token }
        capacityId: ${ bundle.parameters.capacityId }
        description: ${ bundle.parameters.workspaceDescription }
        correlationId: ${ bundle.parameters.correlationId }
        statusDBConnectionString: ${ bundle.credentials.Microsoft_StatusDBConnectionString }
      outputs:
          - name: "workspace_id"
            jsonPath: "$.id"
  - fabric:
      description: "Creating fabric Item"
      group: core.items
      operation: CreateItem
      flags:
        displayName: ${ bundle.parameters.itemDisplayName }
        type: ${ bundle.parameters.itemType }
        Token: ${ bundle.credentials.Microsoft_Fabric_Token }
        workspaceId: ${ bundle.outputs.workspace_id }
        definition: "{}" 
        description: ${ bundle.parameters.itemDescription }
        correlationId: ${ bundle.parameters.correlationId }
        statusDBConnectionString: ${ bundle.credentials.Microsoft_StatusDBConnectionString }
      outputs:
        - name: "item_id"
          jsonPath: "$.id"
```
This mixin step uses both parameters and credentials, defined above, and declares two output values.

### Building the bundle
In order to use this bundle, you'll first need to build it. This is done with the porter command line tool. Ensure that your working directory is set to this example directory before proceeding, then run the following command:

``` bash
porter build 
```

Once this command has finished, you will see a .cnab directory created in the working directory. This directory contains the Dockerfile for the bundle's installer image generated by Porter and the fabric mixin.

### Installing the Bundle
Once you have built the bundle and generated a credential set, you're ready to install the bundle! To do that, you'll use the porter install command:
``` bash
porter install \
--credential-set fabric_credentials \
--param workspaceDisplayName="united_work_space_demo_2024" \
--param capacityId="383e1cee-b196-4f22-aa48-9c67dd00883f" \
--param correlationId="QW1234" \
--param itemDisplayName="United Lakehouse Demo" \
--param itemType="Lakehouse" \
--force 
```

### Post bundle installation

After successfull execution of bundle below is output from execution. Additionally workspace and item created can be checked by logging into fabric portal.
``` bash
Creating Workspace

OUTPUT: {
  "id": "1a8010d0-7082-467b-bbb5-06edabb90f8a",
  "displayName": "united_work_space_demo_2024",
  "description": "United",
  "type": "Workspace",
  "capacityId": "383e1cee-b196-4f22-aa48-9c67dd00883f",
  "correlationId": "QW1234"
}

Creating fabric Item
OUTPUT: {
  "id": "7dd68eef-ccf9-4edb-a1c8-a0bee55f2682",
  "type": "Lakehouse",
  "displayName": "United",
  "description": "United",
  "workspaceId": "1a8010d0-7082-467b-bbb5-06edabb90f8a",
  "correlationId": "QW1234"
}
execution completed successfully!
```
### Possible Issues:




